!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e=e||self).flowplayer=e.flowplayer||{},e.flowplayer.drm=t())}(this,(function(){"use strict";function e(e,t){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];for(var a in t)e[a]=t[a];return e}function t(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return t.slice(1).reduce((function(t,n){return e(t,n)}),t[0]||{})}function n(e,t,n){for(var r=function(e){return Array.isArray(e)?e.slice(0):e.split(".")}(t);r.length;){if(null==e)return n;var a=r.shift();if("string"!=typeof a)return n;e=e[a]}return null==e?n:e}var r="com.widevine.alpha",a="com.microsoft.playready",s="org.w3.clearkey",i="com.apple.fps.1_0",o=Object.freeze({__proto__:null,WIDEVINE:r,PLAYREADY:a,CLEARKEY:s,FAIRPLAY:i,LICENSE_SERVER:"license_server",KEY:"key",KEY_ID:"kid",HTTP_HEADERS:"http_headers",CERTIFICATE:"certificate",VENDOR:"vendor",REQUEST_MEDIA_KEY_SYSTEM_ACCESS_FUNCTION:"request_media_key_system_access_function"});function f(e){var t={};return Object.keys(e).forEach((function(n){var a;a=n,[r].filter((function(e){return e===a})).length&&function(e,t,n){if(e===r){n.widevineLicenseUrl=t[e].license_server,n.emeEnabled=!0;var a=t[e].http_headers;t[e].request_media_key_system_access_function&&(n.requestMediaKeySystemAccessFunc=t[e].request_media_key_system_access_function),a&&(n.licenseXhrSetup=function(e){Object.keys(a).forEach((function(t){e.setRequestHeader(t,a[t])}))})}}(n,e,t)})),t}function c(e){var t={};return Object.keys(e).forEach((function(n){var i;i=n,[r,a,s].filter((function(e){return e===i})).length&&(t[n]=function(e,t){var n={serverURL:t[e].license_server};return t[e].http_headers&&(n.httpRequestHeaders=t[e].http_headers),n}(n,e))})),t}var u=Object.freeze({__proto__:null,fairplay_fetch_certificate:function(e,t){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.addEventListener("load",(function(){t(new Uint8Array(n.response))}),!1),n.open("GET",e,!0),n.send()},fairplay_request_license:function(e,t,n){var r=new XMLHttpRequest;r.responseType="arraybuffer",r.addEventListener("load",(function(){r.status>=400||n(new Uint8Array(r.response))}),!1),r.open("POST",e+t.assetId,!0),r.setRequestHeader("Content-type","application/octet-stream"),r.send(t.message)}});var d=Object.freeze({__proto__:null,fairplay_fetch_certificate:function(e,t){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.addEventListener("load",(function(){t(new Uint8Array(n.response))}),!1),n.open("GET",e,!0),n.send()},fairplay_request_license:function(e,t,n){var r,a,s=new XMLHttpRequest;s.addEventListener("load",(function(){var e,t,r;s.status>=400||n((e=s.response,t=atob(e),r=new Uint8Array(t.length),Array.prototype.forEach.call(t,(function(e,t){r[t]=e.charCodeAt(0)})),r))}),!1),s.open("POST",e,!0),Object.keys(t.headers||{}).forEach((function(e){s.setRequestHeader(e,t.headers[e])})),s.send("assetid="+encodeURIComponent(t.assetId)+"&spc="+(r=t.message,a=Array.prototype.map.call(r,(function(e){return String.fromCharCode(e)})).join(""),btoa(a)))}}),l=Object.freeze({__proto__:null,ezdrm:u,buydrm:d});function p(e,t,n){if(!t[i])return;if(e.src&&0===e.src.indexOf("blob:"))return;const r=t[i].vendor||"ezdrm",a="string"==typeof r?l[r]:r;a.fairplay_fetch_certificate(t[i].certificate,(function(r){e.webkitSetMediaKeys(new WebKitMediaKeys("com.apple.fps.1_0"));var s=n.initData,o=function(e){var t=(n=e,r=new Uint16Array(n.buffer),String.fromCharCode.apply(null,r));var n,r;return t.substring(t.indexOf("skd:")+6).split(";").pop()}(s);s=function(e,t,n){"string"==typeof t&&(t=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0,a=e.length;r<a;r++)n[r]=e.charCodeAt(r);return n}(t));var r=0,a=new ArrayBuffer(e.byteLength+4+t.byteLength+4+n.byteLength),s=new DataView(a);new Uint8Array(a,r,e.byteLength).set(e),r+=e.byteLength,s.setUint32(r,t.byteLength,!0),r+=4;var i=new Uint16Array(a,r,t.length);return i.set(t),r+=i.byteLength,s.setUint32(r,n.byteLength,!0),r+=4,new Uint8Array(a,r,n.byteLength).set(n),new Uint8Array(a,0,a.byteLength)}(s,o,r);var f=e.webkitKeys.createSession("application/x-mpegurl",s);f.addEventListener("webkitkeyerror",console.debug.bind(console,"webkitkeyerror")),f.addEventListener("webkitkeymessage",(function(e){a.fairplay_request_license(t[i].license_server,{message:e.message,assetId:o,headers:t[i].http_headers||{}},(function(e){f.update(e)}))}))}))}function y(e,r,a){a.on("config",(function(t){e=t.data})),a.on("src",(function(r){if(r.data.drm){var s=n(e,"hls",{}),i=r.data.drm?f(r.data.drm):{};a.setOpts({hls:t(s,i)}),a.on("webkitneedkey",p.bind(null,a,r.data.drm||{}));var o=n(e,"dash",{}),u=r.data.drm?c(r.data.drm):{};a.setOpts({dash:t(o,{drm:u})})}}))}return t(y,o),function(e,t){if("object"==typeof exports&&"undefined"!=typeof module)return t;"flowplayer"in e||(e.flowplayer={extensions:[]});var n=e.flowplayer;"function"==typeof n?n(t):(Array.isArray(n.extensions)||(n.extensions=[]),~n.extensions.indexOf(t)||n.extensions.push(t))}(window,y),y}));
