!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):((t=t||self).flowplayer=t.flowplayer||{},t.flowplayer.health=n())}(this,(function(){"use strict";function t(t,n){for(var e=[],r=2;r<arguments.length;r++)e[r-2]=arguments[r];for(var i in n)t[i]=n[i];return t}function n(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n.slice(1).reduce((function(n,e){return t(n,e)}),n[0]||{})}function e(t,n,e){for(var r=function(t){return Array.isArray(t)?t.slice(0):t.split(".")}(n);r.length;){if(null==t)return e;var i=r.shift();if("string"!=typeof i)return e;t=t[i]}return null==t?e:t}var r=Date.now(),i={session_id:Math.random().toString(36).substring(2)+performance.now().toString(36)},o=function(){function t(){this._summary={},this._session_id=i,this.start_time=r}return t.prototype.increment=function(t,n){if("string"==typeof t&&"number"==typeof n){var e=this._summary[t]||0;this._summary[t]=e+n}},t.prototype.set=function(t,n){"string"==typeof t&&(this._summary[t]=n)},t.prototype.duration=function(){return Date.now()-this.start_time},t.prototype.summary=function(t){return n("object"==typeof t?t:{},{event:"health_summary"},this._summary,this._session_id,{duration:this.duration()})},t.prototype.sessionize=function(t){return n(t,this._session_id)},t}();function a(t,n){return function(t,n){return"function"==typeof navigator.sendBeacon&&navigator.sendBeacon(t,n)}(t,JSON.stringify({events:n}))}var s=function(){function t(t){this.middleware=t,this._pending=[]}return t.prototype.pending=function(){return this._pending},t.prototype._run_middleware=function(t,e){return t=n({},t),this.middleware.forEach((function(r){var i=r(e);if("object"==typeof i)return n(t,i);console.warn("KPI::middleware did not return an Object\nreturn: %o\n\nfn: %s",i,r)})),t},t.prototype.push=function(t,n){t=this._run_middleware(t,n),this.push_finalized(t)},t.prototype.push_finalized=function(t){this._pending.push(t),this.send()},t.prototype.send=function(t){if(!(this._pending.length<20)||t){var n=this._pending.slice(0);this._pending.length=0,a("https://health.flowplayer.com/v1/health/events",n)}},t}();function u(){return e(window,"navigator.connection.downlink")}function f(t){var n=t.hls;if(n){var e=n.abrController._bwEstimator;return e?.001*e.getEstimate():void 0}}function d(t){for(var n=[f,u];n.length;){var e=n.shift(),r="function"==typeof e&&e(t);if("number"==typeof r)return{downlink_mbs:Number(r.toFixed(2))}}return{}}function p(t,n,r){return e(t,"opts."+n.toString(),r)}var c=document.createElement("a");function l(t){var n=t.original_src;return"string"!=typeof n?{}:(c.href=n,"string"==typeof c.pathname?{media_type:c.pathname.split(".").pop()}:{})}function h(t){return{version:"2.7.1",preload:t.opt("preload"),autoplay:p(t,"autoplay",t.autoplay),player_id:p(t,"metadata.player_id"),media_id:p(t,"metadata.media_id"),site_id:p(t,"metadata.site_id"),category_id:p(t,"metadata.category_id"),sitegroup_id:p(t,"metadata.sitegroup_id")}}function y(){return{timestamp:Date.now()}}function m(){return{ua:navigator.userAgent,version:"2.7.1"}}var _=["error","rebuffer"],g=_.concat(["load","loadstart","loadedmetadata","loadeddata","error:fatal","playing","seeked","quality:set","pause","ended","seeking"]);return window.addEventListener("unload",(function(){var t=window.flowplayer;t&&"function"==typeof t&&Array.isArray(t.instances)&&t.instances.forEach((function(t){return t.emit("unload")}))})),function(t,n){if("object"==typeof exports&&"undefined"!=typeof module)return n;"flowplayer"in t||(t.flowplayer={extensions:[]});var e=t.flowplayer;return"function"==typeof e?(e(n),n):(Array.isArray(e.extensions)||(e.extensions=[]),~e.extensions.indexOf(n)||e.extensions.push(n),n)}(window,(function(t,e,r){var i=r._health=new o,a=r._kpis=new s([l,h,d,y,m]);i.set("errors",0),i.set("rebuffers",0),function(t){t.on("waiting",(function(n){t.seeking||t.networkState===t.NETWORK_LOADING&&t.readyState!==t.HAVE_NOTHING&&t.emit("rebuffer")}))}(r),r.on("reap",(function(){a.send(),r._kpis=r._health=void 0})),r.on("health:summary:increment",(function(t){for(var n in t.data)i.increment(n,t.data[n])})),r.on("health:summary:set",(function(t){for(var n in t.data)i.set(n,t.data[n])})),r.on(_,(function(t){var n;r.emit("health:summary:increment",((n={})[t.type]=1,n))})),r.on(g,(function(t){r.emit("health:kpi:track",{event:t.type})})),r.on("health:kpi:track",(function(t){var n=i.sessionize(t.data);a.push(n,r)})),r.on("unload",(function(){a.push_finalized(n(i.summary({}),y(),m())),a.send(!0)}))}))}));
